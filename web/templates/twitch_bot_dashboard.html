{% extends "layout.html" %}
{% block title %}Twitch-Bot Dashboard{% endblock %}
{% block content %}

<header class="flex flex-wrap justify-between items-center gap-4 pb-6 border-b border-[#2e3e5e]">
    <div class="flex items-center gap-4">
        <div class="relative">
            <img src="{{ user.profile_image_url }}" alt="{{ user.display_name }}"
                class="size-16 rounded-full border-2 border-purple-500 shadow-lg shadow-purple-500/20">
            <div
                class="absolute -bottom-1 -right-1 size-5 bg-[#9146FF] rounded-full flex items-center justify-center border-2 border-background-dark">
                <svg class="size-3 fill-white" viewBox="0 0 24 24">
                    <path
                        d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z" />
                </svg>
            </div>
        </div>
        <div>
            <h1 class="text-3xl font-black text-white">Twitch Dashboard</h1>
            <p class="text-text-secondary">Eingeloggt als <span class="text-purple-400 font-bold">{{ user.display_name
                    }}</span></p>
        </div>
    </div>
    <div class="flex gap-2">
        <a href="{{ url_for('twitch_login') }}"
            class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white text-sm font-bold border border-white/10 transition-colors">
            Account wechseln
        </a>
    </div>
</header>

<section class="mt-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-purple-400">videocam</span>
            Verfügbare Kanäle
        </h2>
        <p class="text-text-secondary text-sm">Kanäle, auf denen du Moderator oder Broadcaster bist</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for channel in channels %}
        {% set is_active = bot_config.channels.get(channel.broadcaster_login.lower(), {}).active %}
        <div
            class="rounded-2xl bg-card-dark border {{ 'border-purple-500/50 shadow-lg shadow-purple-500/5' if is_active else 'border-[#2e3e5e]' }} p-6 transition-all">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="size-10 bg-purple-500/10 rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-purple-400">person</span>
                    </div>
                    <div>
                        <h3 class="text-white font-bold">{{ channel.broadcaster_name }}</h3>
                        <p class="text-[10px] text-text-secondary uppercase tracking-widest">{{ 'Owner' if
                            channel.broadcaster_id == user.id else 'Moderator' }}</p>
                    </div>
                </div>

                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" {{ 'checked' if is_active }}
                        onchange="toggleBot('{{ channel.broadcaster_login }}', this.checked)" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500">
                    </div>
                </label>
            </div>

            <p class="text-sm text-text-secondary mb-4">
                Wenn aktiviert, tritt der L8teBot deinem Chat bei und reagiert auf Befehle.
            </p>

            <div class="flex items-center gap-2">
                {% if is_active %}
                <span class="size-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-xs text-green-400 font-bold uppercase">Bot Online</span>
                {% else %}
                <span class="size-2 rounded-full bg-gray-500"></span>
                <span class="text-xs text-text-secondary font-bold uppercase">Bot Offline</span>
                {% endif %}
            </div>
            <div class="mt-6 pt-6 border-t border-[#2e3e5e]">
                <h4 class="text-white text-sm font-bold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-xs">terminal</span>
                    Custom Commands
                </h4>

                <div class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                    {% set custom_cmds = bot_config.channels.get(channel.broadcaster_login.lower(), {}).custom_commands
                    %}
                    {% if custom_cmds %}
                    {% for cmd, resp in custom_cmds.items() %}
                    <div
                        class="flex items-center justify-between p-2 rounded bg-background-dark border border-[#2e3e5e] group">
                        <div class="min-w-0">
                            <p class="text-primary text-xs font-bold font-mono">!{{ cmd }}</p>
                            <p class="text-[10px] text-text-secondary truncate">{{ resp }}</p>
                        </div>
                        <button onclick="removeCommand('{{ channel.broadcaster_login }}', '{{ cmd }}')"
                            class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-[10px] text-text-secondary italic">Keine Befehle erstellt</p>
                    {% endif %}
                </div>

                <form onsubmit="addCommand(event, '{{ channel.broadcaster_login }}')" class="flex gap-2">
                    <input type="text" name="command" placeholder="Befehl" required
                        class="w-1/3 px-2 py-1 rounded bg-background-dark border border-[#2e3e5e] text-white text-xs focus:outline-none focus:border-primary">
                    <input type="text" name="response" placeholder="Antwort" required
                        class="flex-1 px-2 py-1 rounded bg-background-dark border border-[#2e3e5e] text-white text-xs focus:outline-none focus:border-primary">
                    <button type="submit" class="p-1 rounded bg-primary text-white hover:bg-blue-600 transition-colors">
                        <span class="material-symbols-outlined text-sm">add</span>
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<section class="mt-12 p-8 rounded-3xl bg-gradient-to-br from-purple-600/20 to-blue-600/20 border border-purple-500/30">
    <div class="flex flex-col md:flex-row gap-8 items-center">
        <div class="size-20 bg-purple-500/20 rounded-2xl flex items-center justify-center shrink-0">
            <span class="material-symbols-outlined text-purple-400 text-5xl">info</span>
        </div>
        <div>
            <h3 class="text-2xl font-black text-white mb-2">Wie es funktioniert</h3>
            <p class="text-text-secondary leading-relaxed">
                Der L8teBot nutzt einen dedizierten Twitch-Account, um in deinem Chat zu schreiben.
                Nachdem du den Bot für einen Kanal aktiviert hast, tritt er innerhalb weniger Sekunden bei.
                <br><br>
                <strong>Befehle im Chat:</strong> <code class="bg-black/30 px-2 py-1 rounded">!l8te</code>, <code
                    class="bg-black/30 px-2 py-1 rounded">!docs</code>
                <br>
                <strong>Eigene Befehle:</strong> Du kannst oben eigene Befehle erstellen. Starte den Befehl einfach mit
                einem Rufzeichen (z.B. <code>!discord</code>).
            </p>
        </div>
    </div>
</section>

<script>
    async function toggleBot(channelName, active) {
        try {
            const response = await fetch(`/twitch/toggle/${channelName}?active=${active}`);
            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (e) {
            showToast('Fehler bei der Verbindung', 'error');
        }
    }

    async function addCommand(event, channelName) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        formData.append('channel_name', channelName);

        try {
            const response = await fetch('/twitch/command/add', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (e) {
            showToast('Fehler bei der Verbindung', 'error');
        }
    }

    async function removeCommand(channelName, command) {
        if (!confirm(`Befehl !${command} wirklich löschen?`)) return;

        const formData = new FormData();
        formData.append('channel_name', channelName);
        formData.append('command', command);

        try {
            const response = await fetch('/twitch/command/remove', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (e) {
            showToast('Fehler bei der Verbindung', 'error');
        }
    }
</script>

{% endblock %}