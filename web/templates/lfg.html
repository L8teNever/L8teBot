{% extends "layout.html" %}
{% block title %}LFG System - {{ guild.name }}{% endblock %}
{% block content %}

<header class="flex flex-col gap-2 mb-8 relative">
    <div class="absolute -top-10 -left-10 w-40 h-40 bg-primary/10 blur-[100px] rounded-full -z-10"></div>
    <div class="flex items-center gap-3">
        <div class="p-2 bg-primary/20 rounded-lg">
            <span class="material-symbols-outlined text-primary text-2xl">search_check</span>
        </div>
        <h1 class="text-white text-3xl md:text-4xl font-black leading-tight tracking-tight">
            Mitspieler <span class="text-primary">Suche</span>
        </h1>
    </div>
    <p class="text-text-secondary text-base max-w-2xl">
        Verwalte die Spielersuche auf deinem Server. Erstelle automatisch Gruppen-Threads und Rollen f√ºr deine
        Community.
    </p>
</header>

<section
    class="rounded-2xl bg-gradient-to-br from-card-dark to-background-dark border border-[#2e3e5e] shadow-2xl overflow-hidden mb-6">
    <div class="p-4 md:p-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <div
                class="h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center text-primary border border-primary/20">
                <span class="material-symbols-outlined text-3xl">groups</span>
            </div>
            <div>
                <h2 class="text-white font-bold text-lg">System f√ºr Mitspieler-Suche</h2>
                <p class="text-text-secondary text-xs">Aktiviere oder deaktiviere die Mitspieler-Suche</p>
            </div>
        </div>
        <form data-ajax="true" action="{{ url_for('toggle_module', guild_id=guild.id) }}" method="post"
            class="flex items-center">
            <input type="hidden" name="cog_name" value="LFG">
            <input type="hidden" name="is_enabled" value="{{ 'False' if is_enabled else 'True' }}">
            <input type="hidden" name="redirect_url" value="{{ request.url }}">
            <label class="flex items-center gap-3 cursor-pointer group">
                <span
                    class="text-sm font-medium transition-colors {{ 'text-primary' if is_enabled else 'text-text-secondary' }}">
                    {{ 'Modul Aktiv' if is_enabled else 'Modul Deaktiviert' }}
                </span>
                <div class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" {% if is_enabled %}checked{% endif %} onchange="this.form.submit()"
                        class="sr-only peer">
                    <div
                        class="w-12 h-6 bg-gray-700/50 backdrop-blur-sm rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[3px] after:start-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all peer-checked:bg-primary shadow-inner">
                    </div>
                </div>
            </label>
        </form>
    </div>
</section>

{% if is_enabled %}
<section class="rounded-lg bg-card-dark border border-[#2e3e5e] overflow-hidden">
    <div class="p-6 border-b border-[#2e3e5e]">
        <h2 class="text-white text-xl font-bold flex items-center gap-2">
            <span class="material-symbols-outlined">settings</span>
            Konfiguration
        </h2>
    </div>
    <div class="p-6">
        <form data-ajax="true" action="{{ url_for('manage_lfg', guild_id=guild.id) }}" method="post" class="space-y-4">
            <input type="hidden" name="action" value="set_config">

            <div class="space-y-6">
                <div>
                    <label class="block text-text-secondary text-sm mb-2 font-medium">Anzeigemodus</label>
                    <select name="display_mode" id="display_mode" required
                        class="w-full px-4 py-2.5 rounded-lg bg-[#1a2333] border border-[#2e3e5e] text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all appearance-none cursor-pointer">
                        <option value="classic" {% if settings.get('display_mode')=='classic' or not
                            settings.get('display_mode') %}selected{% endif %}>
                            üìù Klassisch (Start-Channel & Lobby-Threads)
                        </option>
                        <option value="forum" {% if settings.get('display_mode')=='forum' %}selected{% endif %}>
                            üìÅ Forum (Automatisches Forum mit Game-Tags)
                        </option>
                    </select>
                    <p class="text-[11px] text-text-secondary mt-2 flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">info</span>
                        W√§hle aus, wie die Mitspieler-Suche angezeigt werden soll.
                    </p>
                </div>

                <div>
                    <label class="block text-text-secondary text-sm mb-2 font-medium">Teilnehmer-Rolle (Opt-In)</label>
                    <select name="participation_role"
                        class="w-full px-4 py-2.5 rounded-lg bg-[#1a2333] border border-[#2e3e5e] text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all appearance-none cursor-pointer">
                        <option value="" {% if not settings.get('participation_role_id') %}selected{% endif %}>
                            üîì Alle erlauben (Keine Rolle ben√∂tigt)
                        </option>
                        {% for role in guild.roles|sort(attribute='position', reverse=True) %}
                        {% if role.name != "@everyone" %}
                        <option value="{{ role.id }}" {% if role.id==settings.get('participation_role_id') %}selected{%
                            endif %}>
                            @{{ role.name }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <p class="text-[11px] text-text-secondary mt-2 flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">verified_user</span>
                        Nur User mit dieser Rolle k√∂nnen Suchen erstellen und beitreten. (Leer lassen f√ºr alle)
                    </p>
                </div>

                <!-- Classic Mode Settings -->
                <div id="classic_settings"
                    class="space-y-6 {% if settings.get('display_mode') == 'forum' %}hidden{% endif %}">
                    <div>
                        <label class="block text-text-secondary text-sm mb-2 font-medium">Start-Kanal (Button "Spieler
                            suchen")</label>
                        <select name="start_channel"
                            class="w-full px-4 py-2.5 rounded-lg bg-[#1a2333] border border-[#2e3e5e] text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all appearance-none cursor-pointer">
                            <option value="" disabled {% if not settings.get('start_channel_id') %}selected{% endif %}>
                                Kanal w√§hlen...</option>
                            {% for channel in guild.text_channels|sort(attribute='position') %}
                            <option value="{{ channel.id }}" {% if channel.id==settings.get('start_channel_id')
                                %}selected{% endif %}>
                                #{{ channel.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="text-[11px] text-text-secondary mt-2">Hier wird die Nachricht mit dem Button gepostet.
                        </p>
                    </div>

                    <div>
                        <label class="block text-text-secondary text-sm mb-2 font-medium">Lobby-Kanal (Hier werden alle
                            Suchen gepostet)</label>
                        <select name="lobby_channel"
                            class="w-full px-4 py-2.5 rounded-lg bg-[#1a2333] border border-[#2e3e5e] text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all appearance-none cursor-pointer">
                            <option value="" disabled {% if not settings.get('lobby_channel_id') %}selected{% endif %}>
                                Kanal w√§hlen...</option>
                            {% for channel in guild.text_channels|sort(attribute='position') %}
                            <option value="{{ channel.id }}" {% if channel.id==settings.get('lobby_channel_id')
                                %}selected{% endif %}>
                                #{{ channel.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="text-[11px] text-text-secondary mt-2 text-primary">Der Bot stellt diesen Kanal
                            automatisch auf privat.</p>
                    </div>
                </div>

                <!-- Forum Mode Settings -->
                <div id="forum_settings"
                    class="space-y-6 {% if settings.get('display_mode') != 'forum' %}hidden{% endif %}">
                    <div>
                        <label class="block text-text-secondary text-sm mb-2 font-medium">Such-Forum
                            (Mitspieler-Suche)</label>
                        <select name="lfg_forum_id"
                            class="w-full px-4 py-2.5 rounded-lg bg-[#1a2333] border border-[#2e3e5e] text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all appearance-none cursor-pointer">
                            <option value="" disabled {% if not settings.get('lfg_forum_id') %}selected{% endif %}>Forum
                                w√§hlen...</option>
                            {% for forum in guild.forums|sort(attribute='position') %}
                            <option value="{{ forum.id }}" {% if forum.id==settings.get('lfg_forum_id') %}selected{%
                                endif %}>
                                üí¨ {{ forum.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="text-[11px] text-text-secondary mt-2">Der Bot erstellt automatisch Threads f√ºr jedes
                            Spiel und f√ºgt Tags hinzu.</p>
                    </div>
                </div>

                <div>
                    <label class="block text-text-secondary text-sm mb-2 font-medium">Max. Suchen pro Benutzer</label>
                    <div class="relative">
                        <input type="number" name="max_searches" value="{{ settings.get('max_searches_per_user', 3) }}"
                            min="1" max="10"
                            class="w-full px-4 py-2.5 rounded-lg bg-[#1a2333] border border-[#2e3e5e] text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all">
                    </div>
                </div>

                <script>
                    document.getElementById('display_mode').addEventListener('change', function () {
                        const classic = document.getElementById('classic_settings');
                        const forum = document.getElementById('forum_settings');
                        if (this.value === 'forum') {
                            classic.classList.add('hidden');
                            forum.classList.remove('hidden');
                        } else {
                            classic.classList.remove('hidden');
                            forum.classList.add('hidden');
                        }
                    });
                </script>

                <button type="submit"
                    class="w-full px-4 py-3 rounded-lg bg-primary hover:bg-blue-600 text-white font-bold transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">save</span>
                    √Ñnderungen speichern
                </button>
            </div>
        </form>
    </div>
</section>

<section class="rounded-2xl bg-card-dark border border-[#2e3e5e] overflow-hidden">
    <div class="p-6 border-b border-[#2e3e5e] bg-white/5">
        <h2 class="text-white text-xl font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">help</span>
            Wie funktioniert's?
        </h2>
    </div>
    <div class="p-6">
        <div class="grid md:grid-cols-2 gap-6">
            <div
                class="flex gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:border-primary/20 transition-all">
                <div
                    class="h-10 w-10 shrink-0 rounded-lg bg-primary/10 flex items-center justify-center text-primary font-bold">
                    1</div>
                <div>
                    <h3 class="text-white font-bold mb-1">Suche erstellen</h3>
                    <p class="text-text-secondary text-xs leading-relaxed">User klicken im Start-Kanal auf "Spieler
                        suchen" und f√ºllen das Formular aus.</p>
                </div>
            </div>
            <div
                class="flex gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:border-primary/20 transition-all">
                <div
                    class="h-10 w-10 shrink-0 rounded-lg bg-primary/10 flex items-center justify-center text-primary font-bold">
                    2</div>
                <div>
                    <h3 class="text-white font-bold mb-1">Automatische Gruppe</h3>
                    <p class="text-text-secondary text-xs leading-relaxed">Der Bot erstellt eine einzigartige Rolle und
                        einen privaten Thread f√ºr die Gruppe.</p>
                </div>
            </div>
            <div
                class="flex gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:border-primary/20 transition-all">
                <div
                    class="h-10 w-10 shrink-0 rounded-lg bg-primary/10 flex items-center justify-center text-primary font-bold">
                    3</div>
                <div>
                    <h3 class="text-white font-bold mb-1">Beitreten</h3>
                    <p class="text-text-secondary text-xs leading-relaxed">Andere Teilnehmer sehen die Suche im
                        Lobby-Kanal und k√∂nnen per Button beitreten.</p>
                </div>
            </div>
            <div
                class="flex gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:border-primary/20 transition-all">
                <div
                    class="h-10 w-10 shrink-0 rounded-lg bg-primary/10 flex items-center justify-center text-primary font-bold">
                    4</div>
                <div>
                    <h3 class="text-white font-bold mb-1">Cleanup</h3>
                    <p class="text-text-secondary text-xs leading-relaxed">Wenn die Suche beendet wird, werden Rolle und
                        Thread automatisch gel√∂scht/archiviert.</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% else %}
<div class="rounded-lg p-6 bg-yellow-500/10 border border-yellow-500/30">
    <div class="flex items-start gap-4">
        <span class="material-symbols-outlined text-yellow-400 text-3xl">info</span>
        <div>
            <h3 class="text-white font-bold mb-1">Modul deaktiviert</h3>
            <p class="text-yellow-200 text-sm">Aktiviere das System f√ºr Mitspieler-Suche, um Einstellungen zu sehen.</p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}